<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <title>ICH Atlas</title>

    <link
      rel="icon"
      type="image/png"
      href="../assets/favicon-96x96.png?"
      sizes="96x96"
    />
    <link rel="icon" type="image/svg+xml" href="../assets/favicon.svg?" />
    <link rel="shortcut icon" href="../assets/favicon.ico?" />

    <link rel="stylesheet" href="../styles/style.css" />
    <link rel="stylesheet" href="../styles/modal.css" />
    <link rel="stylesheet" href="../styles/menu.css" />
    <style>
      #chart-container {
        width: 100%;
        height: 100%;
      }
    </style>

    <script src="../lib/d3.js"></script>
    <script src="../lib/d3-delaunay.js"></script>
    <script src="../lib/d3-bboxCollide.min.js"></script>
    <script src="../scripts/manageFonts.js"></script>
    <script src="../scripts/createCompetencesMap.js"></script>
  </head>
  <body style="overflow: hidden">
    <!-- Navigation Menu -->
    <!-- Icons from https://phosphoricons.com/ Phosphor is a passion project by Helena Zhang and Tobias Fried. -->
    <nav id="floating-nav">
      <!-- MENU TOGGLE -->
      <button id="menu-btn" class="menu-btn" aria-label="Apri menu">
        <span class="menu-line"></div>
      </button>

      <div class="menu-items">
      <button class="icon menu-item" id="search-btn" aria-label="Cerca" data-hint="Search nodes">
        <!-- SVG search -->
      </button>

      <button
        class="icon menu-item"
        id="info-btn"
        aria-label="Info"
        data-hint="Open legend (I)"
      >
        <!-- SVG info -->
      </button>

      <button
        class="icon menu-item"
        id="download-btn-nav"
        aria-label="Download"
        data-hint="Download dataset .xlsx (D)"
      >
        <!-- Data download -->
      </button>

      <button
        class="icon menu-item"
        id="camera-btn"
        aria-label="Scarica immagine"
        data-hint="Download image .png (S)"
      >
        <!-- Screenshot -->
      </button>

      <button class="icon menu-item" id="more-btn" aria-label="Altro" data-hint="Navigate to visualisations">
        <!-- SVG more -->
      </button>
      </div>
    </nav>

    <!-- trigger nascosto per il download -->
    <a id="trigger" href="#" style="display: none"></a>

    <!-- chart-->
    <div id="chart-container"></div>

    <!-- legend modal -->
    <div id="legend-modal" class="modal">
      <div class="modal-content">
        <span class="close" id="modal-close">&times;</span>
        <div id="modal-body-image">
          <img id="modal-img" src="" alt="Legenda">
        </div>
      </div>
    </div>

    <!-- link modal -->
    <div id="link-modal" class="modal">
      <div class="modal-content">
        <span class="close" id="modal-close">&times;</span>
        <div id="search-bar"></div>
        <div id="modal-body"></div>
      </div>
    </div>

    <!-- tooltips & project modals, serve ancora?-->
    <div id="tooltips-container"></div> 
    <script src="../scripts/menu.js"></script>
    <script src="../scripts/modal.js"></script>
    <script type="text/javascript">
      // Get the container element that will hold the chart
      let container = document.getElementById("chart-container");
      let width = container.offsetWidth;
      let height = container.offsetHeight;

      //Get the datasets file paths
      let excelDataset = "../data/download/Competences-Map-Dataset.xlsx";
      let skillDataset = "../data/competences-map-skill.csv";
      let techDataset = "../data/competences-map-tech.csv";
      let projDataset = "../data/projects-description.csv";

      //let the .xlsx dataset be downloaded
      downloadData(excelDataset, "TRAMA-competences-map-dataset");

      //Set up the visual
      //the viz won't be drawed at this stage
      let drawMap = createCompetencesMap(container).width(width).height(height);

      //load data asynchronously
      Promise.all([
        d3.csv(skillDataset),
        d3.csv(techDataset),
        d3.csv(projDataset),
      ]).then(function (data) {
        //after the data is loaded assing variables and...
        let skillData = data[0];
        let techData = data[1];
        let projData = data[2];

        //...call the chart object with the data to draw
        drawMap(skillData, techData, projData);
      });

      document.getElementById("camera-btn").addEventListener("click", () => {
        drawMap.downloadPNG(); // Download image as .png
      });

      //handle responsiviness
      let resizeTimer;
      window.addEventListener("resize", function () {
        clearTimeout(resizeTimer); //set a timer if changes had not be useful
        resizeTimer = setTimeout(() => {
          //get new sizes
          width = container.offsetWidth;
          height = container.offsetHeight;

          //update the visual
          drawMap.width(width).height(height).resize();
        }, 250);
      });
    </script>
  </body>
</html>
